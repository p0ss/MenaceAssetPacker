# Asset Reference Resolution System

## Overview

This system resolves Unity Object references (instance IDs) to human-readable asset names and links them to extracted asset files. It enables the Stats Editor to display meaningful names instead of raw memory addresses.

## Architecture

```
┌─────────────────────────────────┐
│      Menace.Modkit.App          │
│  ┌───────────────────────────┐  │
│  │ AssetRipperService        │  │  Orchestrates extraction
│  │ (automated extraction)    │  │
│  └─────────────┬─────────────┘  │
│                │                 │
│  ┌─────────────▼─────────────┐  │
│  │ AssetReferenceResolver    │  │  Resolves IDs to names
│  │ (loads AssetReferences)   │  │
│  └─────────────┬─────────────┘  │
│                │                 │
│  ┌─────────────▼─────────────┐  │
│  │ StatsEditorViewModel      │  │  Displays resolved names
│  │ AssetPickerDialog         │  │  Browse/select assets
│  └───────────────────────────┘  │
└─────────────────────────────────┘
           │
           │ Uses
           ▼
┌─────────────────────────────────┐
│      Game Runtime               │
│  ┌───────────────────────────┐  │
│  │ DataExtractor Mod         │  │  Extracts templates +
│  │                           │  │  builds reference table
│  └───────────────────────────┘  │
└─────────────────────────────────┘
           │
           │ Produces
           ▼
┌─────────────────────────────────┐
│  UserData/ExtractedData/        │
│  ├── AssetReferences.json       │  { InstanceId → Name, Type }
│  ├── WeaponTemplate.json        │  Template data with IDs
│  └── ...                        │
└─────────────────────────────────┘
```

## GUI Workflow

### Automatic Setup

The Menace Modkit app handles asset extraction automatically:

1. **First Launch** — App detects game installation
2. **Data Extraction** — Prompts to launch game with DataExtractor
3. **Asset Ripping** — AssetRipperService extracts game assets
4. **Reference Matching** — Resolves instance IDs to asset files

After setup, the Stats Editor displays asset names instead of raw IDs.

### Asset Picker Dialog

When editing a field that references an asset (Sprite, Texture2D, etc.):

1. Click the field in Stats Editor
2. **AssetPickerDialog** opens with:
   - Search/filter by name
   - Preview panel for images
   - "modpack" badge for assets already in your modpack
3. Select an asset or click **Import New...** to add external files
4. Selected asset is registered in your modpack manifest

### Browsing Assets

The **Asset Browser** tab provides full asset exploration:

- Browse by type (Sprites, Textures, Audio, Meshes)
- Search across all extracted assets
- Preview images and metadata
- Set up asset replacements for modpacks

## Components

### AssetRipperService

**File:** `src/Menace.Modkit.App/Services/AssetRipperService.cs`

Orchestrates asset extraction:
- Runs AssetRipper with appropriate settings
- Manages extraction profiles (Essential, Standard, Complete)
- Tracks extraction state in manifest
- Handles cache invalidation on game updates

### AssetReferenceResolver

**File:** `src/Menace.Modkit.App/Services/AssetReferenceResolver.cs`

Resolves instance IDs to display information:

```csharp
var resolver = new AssetReferenceResolver();
resolver.LoadReferences(gameInstallPath);

var resolved = resolver.Resolve(instanceId);

if (resolved.IsReference)
{
    // resolved.DisplayValue  → "icon_ammo"
    // resolved.AssetPath     → "Assets/Sprites/icon_ammo.png"
    // resolved.AssetType     → "Sprite"
}
```

**ResolvedAsset Properties:**
- `DisplayValue` — Human-readable text for UI
- `IsReference` — Is this an asset reference?
- `AssetName` — Name from runtime extraction
- `AssetType` — Unity type (Sprite, AudioClip, etc.)
- `AssetPath` — Relative path to extracted file
- `HasAssetFile` — Whether the file exists
- `CanLinkToAssetBrowser` — Can navigate to browser

### AssetPickerDialog

**File:** `src/Menace.Modkit.App/Views/AssetPickerDialog.cs`

Modal dialog for asset selection:
- Filters by asset type
- Shows both extracted and modpack assets
- Supports importing new assets
- Provides image preview

## Data Files

### AssetReferences.json

Generated by DataExtractor, maps instance IDs to metadata:

```json
[
  {
    "InstanceId": 1976593696,
    "Name": "items.armor_piercing_ammo.title",
    "Type": "LocalizedLine",
    "AssetPath": ""
  },
  {
    "InstanceId": 1937563168,
    "Name": "icon_ammo_armor_piercing",
    "Type": "Sprite",
    "AssetPath": "Assets/Sprites/icon_ammo_armor_piercing.png"
  }
]
```

### Field Type Display

| Field Type | Extraction | Display in Stats Editor |
|------------|------------|-------------------------|
| `int`, `float`, `bool` | Direct read | `42`, `1.5`, `true` |
| `LocalizedLine` | Text @ offset 0x40 | `"Armor Piercing Ammo"` |
| `Sprite`, `Texture2D` | Instance ID → lookup | `icon_ammo` (clickable) |
| `AudioClip` | Instance ID → lookup | `explosion_sound` |
| `GameObject` | Instance ID → lookup | `model_tank` |
| Unknown reference | Instance ID | `[Ref:1976593696]` |

## Error Handling

**No AssetReferences.json:**
- Stats Editor displays raw instance IDs
- Still functional, prompts for data extraction

**Asset file not found:**
- Displays: `asset_name (no file)`
- Shows name from runtime, just can't preview

**Extraction failed:**
- Error logged to app log
- Retry available in Settings tab

## Modpack Asset Structure

When you import or replace assets, they're stored in your modpack:

```
MyModpack/
├── modpack.json
└── assets/
    └── Assets/
        ├── Sprite/
        │   └── custom_icon.png
        └── Texture2D/
            └── custom_texture.png
```

The manifest tracks replacements:

```json
{
  "assets": {
    "Assets/Sprite/icon_ammo": "assets/Assets/Sprite/custom_icon.png"
  }
}
```

---

## Advanced: Manual Workflow

For developers or troubleshooting, the system can be run manually.

### match_asset_references.py

Matches extracted references to AssetRipper output files:

```bash
python3 match_asset_references.py
# Scans AssetRipper exports
# Updates AssetPath fields in AssetReferences.json
```

**Matching Logic:**
1. Exact match by filename (without extension)
2. Type-aware matching (prefer `.png` for Sprites, `.wav` for AudioClips)
3. Fuzzy match for name variations

### Manual Re-extraction

If automatic extraction fails:

1. Run game with DataExtractor mod
2. Check `UserData/ExtractedData/` for output
3. Run `python3 match_asset_references.py` to update paths
4. Restart the modkit app

## Future Enhancements

- **Clickable asset links** — Navigate from Stats Editor to Asset Browser
- **Asset preview thumbnails** — Inline previews for Sprites
- **Reverse lookup** — Show which templates reference an asset
- **Hot reload** — Auto-refresh when assets change
